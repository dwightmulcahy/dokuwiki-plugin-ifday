name: Build DokuWiki Plugin ZIP and Changelog on version tag (i.e., v1.0.0)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest

    env:
      INCLUDE_FILES: |
        plugin.info.txt
        README.md
        LICENSE
        action.php
        admin.php
        helper.php
        helper_*.php
        metadata.php
        metadata_*.php
        install.php
        meta.php
        syntax.php
        conf/
        lang/
        doc/
        tpl/
        styles.css
        script.js
        config/
        tests/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract plugin name from repo name
        id: extract_plugin_name
        run: |
          repo="${GITHUB_REPOSITORY##*/}"
          prefix="dokuwiki-plugin-"
          if [[ "$repo" == "$prefix"* ]]; then
            plugin_name="${repo#$prefix}"
          else
            plugin_name="$repo"
          fi
          echo "PLUGIN_NAME=$plugin_name" >> "$GITHUB_ENV"

      - name: Setup git config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install git-cliff
        run: |
          curl -sSL https://github.com/orhun/git-cliff/releases/download/v2.10.0/git-cliff-2.10.0-x86_64-unknown-linux-gnu.tar.gz | tar -xz
          sudo mv git-cliff-2.10.0/git-cliff /usr/local/bin/git-cliff
          git-cliff --version

      - name: Generate CHANGELOG.md from commits
        run: git-cliff --config cliff.toml -o CHANGELOG.md

      - name: Update plugin date in plugin.info.txt with a real tab
        run: |
          set -euo pipefail
          today=$(TZ=America/Chicago date +'%Y-%m-%d')

          # Normalize only the 'date' line to: "date<TAB>YYYY-MM-DD"
          awk -v today="$today" 'BEGIN{FS="[ \t]+"; OFS="\t"}
            /^date[ \t]/ { print "date", today; next }
            { print }
          ' plugin.info.txt > plugin.info.txt.tmp

          # Ensure UTF-8 without BOM
          iconv -f UTF-8 -t UTF-8 -o plugin.info.txt plugin.info.txt.tmp
          rm -f plugin.info.txt.tmp

          echo "Updated plugin date to ${today}"
          printf '--- plugin.info.txt ---\n'; cat -A plugin.info.txt

          # Commit only if there are changes
          if ! git diff --quiet plugin.info.txt; then
            git add plugin.info.txt
            git commit -m "chore: update plugin.info.txt date to ${today}"
            git push
          else
            echo "No changes to commit"
          fi

      - name: Build release ZIP with correct top-level folder
        run: |
          set -euo pipefail
          shopt -s nullglob

          VERSION="${GITHUB_REF_NAME#v}"  # tag v1.2.3 -> 1.2.3
          STAGE="build/stage"
          OUTDIR="build"
          mkdir -p "$STAGE" "$OUTDIR"

          # Stage under PLUGIN_NAME/ so the zip root is correct
          DEST="$STAGE/${PLUGIN_NAME}"
          rm -rf "$DEST"
          mkdir -p "$DEST"

          # Add included files and directories if present
          while IFS= read -r item; do
            [[ -z "$item" ]] && continue
            found=0
            for path in $item; do
              if [[ -e "$path" ]]; then
                found=1
                echo "Adding $path"
                rsync -a "$path" "$DEST"/
              fi
            done
            if [[ $found -eq 0 ]]; then
              echo "Skipping missing $item"
            fi
          done <<< "${INCLUDE_FILES}"

          # Create versioned zip
          ZIP_FILE="${OUTDIR}/${PLUGIN_NAME}-${VERSION}.zip"
          rm -f "$ZIP_FILE"
          (cd "$STAGE" && zip -r -q "../${PLUGIN_NAME}-${VERSION}.zip" "${PLUGIN_NAME}")

          # Copy changelog alongside
          cp CHANGELOG.md "$OUTDIR"/

          echo "Created $ZIP_FILE"

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: build/CHANGELOG.md
          files: |
            build/${{ env.PLUGIN_NAME }}-${{ github.ref_name || 'v0.0.0' }}.zip
            build/CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
